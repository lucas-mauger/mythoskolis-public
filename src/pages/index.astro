---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import MetaTags from '../components/MetaTags.astro';
import '../styles/global.css';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const entites = await getCollection('entites');
const publicDir = path.resolve(process.cwd(), 'public');

function findFirstExistingFace(slug: string, id?: string, culture?: string): string | null {
  const normalizedCulture = culture?.toString().toLowerCase();
  const defaultCulture = 'grecque';
  const normalizedSlug = `${normalizedCulture ?? defaultCulture}-${slug}`;
  const bases: string[] = [];

  if (normalizedCulture) {
    if (id) bases.push(`faces/${normalizedCulture}/${id}`);
    bases.push(`faces/${normalizedCulture}/${normalizedSlug}`);
    bases.push(`faces/${normalizedCulture}/${slug}`);
  }
  if (id) bases.push(`faces/${defaultCulture}/${id}`);
  bases.push(`faces/${defaultCulture}/${normalizedSlug}`);
  bases.push(`faces/${defaultCulture}/${slug}`);
  if (id) bases.push(`faces/${id}`);
  bases.push(`faces/${slug}`);

  for (const base of bases) {
    const full = path.join(publicDir, `${base}.webp`);
    if (fs.existsSync(full)) {
      return '/' + `${base}.webp`;
    }
  }
  return null;
}

const entitesAvecPortrait = entites
  .map((item) => {
    const face = findFirstExistingFace(item.slug, item.data.id?.toString(), item.data.culture);
    if (!face) return null;
    return {
      id: item.data.id ?? item.slug,
      slug: item.slug,
      title: item.data.title,
      role: item.data.role ?? '',
      faceSrc: face,
    };
  })
  .filter(Boolean);

const serializedEntites = JSON.stringify(entitesAvecPortrait);
---

<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <MetaTags
      title="Mythoskolis — mythes, HoloGraph et fiches"
      description="Découvre l’HoloGraph, la généalogie interactive de Mythoskolis : un graphe dynamique pour explorer dieux, titans et héros."
      canonical="/"
      type="website"
    />
  </head>

  <body class="min-h-screen flex flex-col bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <Header />

    <main class="flex-1 max-w-4xl mx-auto px-3 sm:px-4 py-12 space-y-12">
      <section
        class="home-hero mk-card-strong mk-pan-bg relative overflow-hidden p-6 md:p-8 flex flex-col gap-4 min-w-0 w-full bg-[url('/medias/mythoskolis_front.webp')] bg-top"
      >
        <div class="absolute inset-0 bg-black/30" aria-hidden="true"></div>

        <div class="relative z-10 flex flex-col gap-3">
          <h1 class="text-center font-extrabold leading-tight text-white drop-shadow">
            <span class="block text-4xl md:text-5xl">Mythoskolis</span>
            <span class="block text-2xl md:text-4xl">La mythologie grecque facile à comprendre</span>
          </h1>

          <p class="mk-lead max-w-3xl">
            Parcourez les fiches d'entités mythologiques, les récits fondateurs, et comprenez intuitivement les liens de filiation entre les personnages via l'HoloGraph, un arbre généalogique interactif original et inédit.
          </p>
        </div>
      </section>


      <section class="mk-card space-y-4 p-8">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-50">HoloGraph - généalogie interactive</h2>
          <a
            href="/genealogie/grecque-zeus/"
            class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 hover:border-indigo-300 hover:bg-indigo-50 transition dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:hover:border-indigo-300/60"
          >
            Ouvrir l’HoloGraph
          </a>
        </div>
        <p class="text-slate-700 dark:text-slate-200">
          Naviguez intuitivement dans les complexes relations généalogiques de la mythologie grecque.
        </p>
        <div class="flex justify-center">
          <video
            class="w-full sm:w-4/5 lg:w-1/2 rounded-2xl border border-slate-200 shadow-md dark:border-slate-700"
            autoplay
            muted
            loop
            playsinline
            controlslist="nodownload noplaybackrate"
            disablepictureinpicture
            oncontextmenu="event.preventDefault();"
          >
            <source src="/medias/holograph.mp4" type="video/mp4" />
            Votre navigateur ne supporte pas la vidéo HTML5.
          </video>
        </div>
      </section>

      <section class="mk-card space-y-4 p-8">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-50">Quelques entités à découvrir</h2>
        </div>
        <div data-home-random-entities class="grid gap-4 sm:grid-cols-2 md:grid-cols-3">
          <p class="text-slate-500 dark:text-slate-300">Chargement des entités...</p>
        </div>
      </section>

      <section class="mk-card space-y-4 p-8">
        <div class="flex flex-col gap-3 min-w-0">
          <div class="flex items-center gap-3">
            <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-50">Ressources</h2>
          </div>
          <p class="text-slate-700 dark:text-slate-200">
            Analyses, fiches pédagogiques et sources antiques pour approfondir.
          </p>
          <a
            href="/ressources/"
            class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 hover:border-indigo-300 hover:bg-indigo-50 transition text-center dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:hover:border-indigo-300/60 self-start"
          >
            Voir toutes les ressources
          </a>
        </div>
      </section>

      <section class="mk-card space-y-3 p-8">
      <div class="flex flex-col gap-3 min-w-0">
        <div class="flex items-center gap-3">
          <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-50">À propos</h2>
        </div>
          <p class="text-slate-700 dark:text-slate-200">
            Mythoskolis est un projet personnel conçu avec Astro et Tailwind.
            Il sert de vitrine culturelle et surtout de démonstration technique : modélisation de données complexes, structuration YAML, et visualisation dynamique via l’HoloGraph.
            Toutes les fiches et relations sont versionnées, sourcées, et générées à partir de données organisées.
          </p>
          <a 
            href="/a-propos/" 
            class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 hover:border-indigo-300 hover:bg-indigo-50 transition text-center dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:hover:border-indigo-300/60 self-start">
            En savoir plus
          </a>
      </div>
      </section>
    </main>

    <Footer />

    <script type="application/json" id="home-random-entities-data" set:html={serializedEntites}></script>

    <script>
      (() => {
        const renderRandomEntities = () => {
          const container = document.querySelector('[data-home-random-entities]');
          const dataEl = document.getElementById('home-random-entities-data');
          if (!container || !dataEl) return;

          try {
            const parsed = JSON.parse(dataEl.textContent || '[]');
            console.debug('[home-entities] parsed length', Array.isArray(parsed) ? parsed.length : 'non-array');
            if (!Array.isArray(parsed) || parsed.length === 0) {
              container.innerHTML = '<p class="text-slate-500 dark:text-slate-300">Aucune entité illustrée pour le moment.</p>';
              return;
            }

            const selection = parsed
              .map((value) => ({ value, sort: Math.random() }))
              .sort((a, b) => a.sort - b.sort)
              .slice(0, 3)
              .map(({ value }) => value);

            const fragment = document.createDocumentFragment();

            selection.forEach((ent) => {
              const card = document.createElement('a');
              card.href = `/entites/${ent.id}/`;
              card.className =
                'home-entity-card mk-card group relative overflow-hidden rounded-2xl hover:shadow-md transition dark:hover:shadow-lg';

              const img = document.createElement('img');
              img.src = ent.faceSrc;
              img.alt = `Portrait de ${ent.title}`;
              img.className = 'h-40 w-full object-cover bg-slate-100 dark:bg-slate-800';
              img.loading = 'lazy';
              img.draggable = false;
              card.appendChild(img);

              const info = document.createElement('div');
              info.className = 'p-4 flex items-center justify-between';

              const texts = document.createElement('div');
              const title = document.createElement('p');
              title.className =
                'home-entity-title text-lg font-semibold text-slate-900 transition group-hover:text-indigo-700 dark:text-slate-50 dark:group-hover:text-indigo-200';
              title.textContent = ent.title;

              const role = document.createElement('p');
              role.className = 'home-entity-sub text-xs text-slate-500 dark:text-slate-300';
              role.textContent = ent.role || 'Fiche détaillée';

              texts.appendChild(title);
              texts.appendChild(role);

              const arrow = document.createElement('span');
              arrow.className = 'text-indigo-600 font-semibold transition group-hover:translate-x-1 dark:text-indigo-200';
              arrow.textContent = '→';

              info.appendChild(texts);
              info.appendChild(arrow);

              card.appendChild(info);
              fragment.appendChild(card);
            });

            if (fragment.childNodes.length > 0) {
              container.innerHTML = '';
              container.appendChild(fragment);
            }
          } catch (error) {
            console.error('[home-entities] rendu aléatoire impossible', error);
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', renderRandomEntities, { once: true });
        } else {
          renderRandomEntities();
        }
      })();
    </script>
  </body>
</html>
