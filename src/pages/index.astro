---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import MetaTags from '../components/MetaTags.astro';
import '../styles/global.css';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const entites = await getCollection('entites');
const publicDir = path.resolve(process.cwd(), 'public');
const fallbackFace =
  "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='180' viewBox='0 0 320 180' fill='none'%3E%3Crect width='320' height='180' rx='16' fill='%23E2E8F0'/%3E%3Ctext x='50%25' y='52%25' dominant-baseline='middle' text-anchor='middle' fill='%23475569' font-family='Arial, sans-serif' font-size='48'%3E?%3C/text%3E%3C/svg%3E";
import homeEntitiesCarouselUrl from '../scripts/home-entities-carousel.ts?url';

function findFirstExistingFace(slug: string, id?: string, culture?: string): string | null {
  const normalizedCulture = culture?.toString().toLowerCase();
  const defaultCulture = 'grecque';
  const normalizedSlug = `${normalizedCulture ?? defaultCulture}-${slug}`;
  const bases: string[] = [];

  if (normalizedCulture) {
    if (id) bases.push(`faces/${normalizedCulture}/${id}`);
    bases.push(`faces/${normalizedCulture}/${normalizedSlug}`);
    bases.push(`faces/${normalizedCulture}/${slug}`);
  }
  if (id) bases.push(`faces/${defaultCulture}/${id}`);
  bases.push(`faces/${defaultCulture}/${normalizedSlug}`);
  bases.push(`faces/${defaultCulture}/${slug}`);
  if (id) bases.push(`faces/${id}`);
  bases.push(`faces/${slug}`);

  for (const base of bases) {
    const full = path.join(publicDir, `${base}.webp`);
    if (fs.existsSync(full)) {
      return '/' + `${base}.webp`;
    }
  }
  return null;
}

const entitesAvecPortrait = entites
  .map((item) => {
    const face = findFirstExistingFace(item.slug, item.data.id?.toString(), item.data.culture);
    if (!face) return null;
    return { item, face };
  })
  .filter(Boolean);

const candidates = entitesAvecPortrait.map(({ item, face }) => ({
  id: item.data.id ?? item.slug,
  slug: item.slug,
  title: item.data.title,
  role: item.data.role ?? '',
  faceSrc: face,
}));

console.log("[home-entities] candidates.length =", candidates.length);
console.log("[home-entities] candidates slugs =", candidates.map((c) => c.slug));
const fallbackFeatured = candidates.slice(0, 6);
---

<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <MetaTags
      title="Mythoskolis — mythes, HoloGraph et fiches"
      description="Découvre l’HoloGraph, la généalogie interactive de Mythoskolis : un graphe dynamique pour explorer dieux, titans et héros."
      canonical="/"
      type="website"
    />
  </head>

  <body class="min-h-screen flex flex-col bg-gray-50 text-gray-900">
    <Header />

    <main class="flex-1 max-w-5xl mx-auto px-4 py-12 space-y-12">
      <section class="home-hero rounded-3xl bg-white border border-gray-200 shadow-sm p-8 flex flex-col gap-4">
        <p class="text-sm font-semibold tracking-[0.2em] text-indigo-600 uppercase">Mythologie vivante</p>
        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight text-gray-900">
          Mythoskolis<br />
          La Mythologie accessible à tous
        </h1>
        <p class="text-lg text-gray-700 max-w-3xl">
          Parcourez les fiches d'entités mythologiques, les récits fondateurs, et comprenez intuitivement les liens de filiation entre les personnages via l'HoloGraph, un arbre généalogique interactif original et inédit.
        </p>
        <div class="flex flex-wrap gap-3">
          <a
            class="inline-flex items-center gap-2 rounded-full bg-indigo-600 text-white px-4 py-2 font-semibold shadow hover:bg-indigo-700 transition"
            href="/entites/"
          >
            Explorer les entités
          </a>
          <a
            class="inline-flex items-center gap-2 rounded-full border border-indigo-200 text-indigo-700 px-4 py-2 font-semibold bg-indigo-50 hover:border-indigo-300 transition"
            href="/genealogie/grecque-zeus/"
          >
            Ouvrir l’HoloGraph
          </a>
        </div>
      </section>

      <section class="space-y-4 rounded-3xl bg-white border border-gray-200 shadow-sm p-8">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold">HoloGraph — généalogie interactive</h2>
          <a
            href="/genealogie/grecque-zeus/"
            class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1.5 text-sm font-semibold text-gray-700 hover:border-indigo-300 hover:bg-indigo-50 transition"
          >
            Ouvrir l’HoloGraph
          </a>
        </div>
        <p class="text-gray-700">
          Visualise parents, fratries, consorts et enfants avec l’HoloGraph, le graphe interactif de Mythoskolis.
        </p>
        <div class="flex justify-center">
          <video
            class="w-1/2 rounded-2xl border border-gray-200 shadow-md"
            autoplay
            muted
            loop
            playsinline
            controlslist="nodownload noplaybackrate"
            disablepictureinpicture
            oncontextmenu="event.preventDefault();"
          >
            <source src="/medias/holograph.mp4" type="video/mp4" />
            Votre navigateur ne supporte pas la vidéo HTML5.
          </video>
        </div>
      </section>

      <section class="space-y-6">
        <h2 class="text-2xl font-semibold">Quelques entités à découvrir</h2>
        <div id="home-entities-grid" data-home-entities-grid class="grid gap-4 sm:grid-cols-2 md:grid-cols-3">
          {fallbackFeatured.map((ent) => (
            <a
              class="home-entity-card group relative overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition"
              href={`/entites/${ent.id}/`}
            >
              <img
                src={ent.faceSrc}
                alt={`Portrait de ${ent.title}`}
                class="h-40 w-full object-cover bg-gray-100"
                loading="lazy"
                onerror={`this.onerror=null;this.src='${fallbackFace}';`}
                draggable="false"
              />
              <div class="p-4 flex items-center justify-between">
                <div>
                  <p class="home-entity-title text-lg font-semibold text-gray-900 group-hover:text-indigo-700 transition">
                    {ent.title}
                  </p>
                  <p class="home-entity-sub text-xs text-gray-500">Fiche détaillée</p>
                </div>
                <span class="text-indigo-600 font-semibold group-hover:translate-x-1 transition">→</span>
              </div>
            </a>
          ))}
        </div>
      </section>

      <section class="space-y-4 rounded-3xl bg-white border border-gray-200 shadow-sm p-8">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold">Ressources</h2>
          <a
            href="/ressources/"
            class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1.5 text-sm font-semibold text-gray-700 hover:border-indigo-300 hover:bg-indigo-50 transition"
          >
            Voir toutes les ressources
          </a>
        </div>
        <p class="text-gray-700">Analyses, fiches pédagogiques et sources antiques pour approfondir.</p>
      </section>

      <section class="space-y-3 rounded-3xl bg-white border border-gray-200 shadow-sm p-8">
        <h2 class="text-2xl font-semibold">À propos</h2>
        <p class="text-gray-700">
          Mythoskolis est un projet personnel en Astro/Netlify, pensé comme une vitrine culturelle et technique
          autour des mythes. Tout le contenu est versionné, sourcé, et l’HoloGraph s'appuie sur des données YAML.
        </p>
        <div class="flex flex-wrap gap-3 text-sm">
          <a href="/a-propos/" class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1.5 hover:border-gray-300">
            En savoir plus
          </a>
      <a href="/entites/" class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1.5 hover:border-gray-300">
        Consulter les fiches
      </a>
    </div>
  </section>
</main>

<Footer />

<script type="application/json" id="home-entities-data">
  {JSON.stringify(candidates)}
</script>

<script type="module" src={homeEntitiesCarouselUrl}></script>

<style>
  :global(.theme-dark .home-entity-card) {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(148, 163, 184, 0.4);
  }
  :global(.theme-dark .home-entity-title) {
    color: #e5e7eb;
  }
  :global(.theme-dark .home-entity-sub) {
    color: #cbd5e1;
  }
  :global(.theme-dark .home-entity-card .text-indigo-600) {
    color: #c4d4ff;
  }
  /* Hero dark mode */
  :global(.theme-dark .home-hero) {
    background: rgba(15, 23, 42, 0.9);
    border-color: rgba(148, 163, 184, 0.25);
  }
  :global(.theme-dark .home-hero h1) {
    color: #e5e7eb;
  }
  :global(.theme-dark .home-hero p:not(.text-indigo-600)) {
    color: #cbd5e1;
  }
  :global(.theme-dark .home-hero .text-indigo-600) {
    color: #a5b4fc;
  }
</style>
</body>
</html>
