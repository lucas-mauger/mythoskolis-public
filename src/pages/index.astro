---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import MetaTags from '../components/MetaTags.astro';
import '../styles/global.css';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const entites = await getCollection('entites');
const publicDir = path.resolve(process.cwd(), 'public');

function findFirstExistingFace(slug: string, id?: string, culture?: string): string | null {
  const normalizedCulture = culture?.toString().toLowerCase();
  const defaultCulture = 'grecque';
  const normalizedSlug = `${normalizedCulture ?? defaultCulture}-${slug}`;
  const bases: string[] = [];

  if (normalizedCulture) {
    if (id) bases.push(`faces/${normalizedCulture}/${id}`);
    bases.push(`faces/${normalizedCulture}/${normalizedSlug}`);
    bases.push(`faces/${normalizedCulture}/${slug}`);
  }
  if (id) bases.push(`faces/${defaultCulture}/${id}`);
  bases.push(`faces/${defaultCulture}/${normalizedSlug}`);
  bases.push(`faces/${defaultCulture}/${slug}`);
  if (id) bases.push(`faces/${id}`);
  bases.push(`faces/${slug}`);

  for (const base of bases) {
    const full = path.join(publicDir, `${base}.webp`);
    if (fs.existsSync(full)) {
      return '/' + `${base}.webp`;
    }
  }
  return null;
}

const entitesAvecPortrait = entites
  .map((item) => {
    const face = findFirstExistingFace(item.slug, item.data.id?.toString(), item.data.culture);
    if (!face) return null;
    return {
      id: item.data.id ?? item.slug,
      slug: item.slug,
      title: item.data.title,
      role: item.data.role ?? '',
      faceSrc: face,
    };
  })
  .filter(Boolean);

const serializedEntites = JSON.stringify(entitesAvecPortrait);
---

<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <MetaTags
      title="Mythoskolis — mythes, HoloGraph et fiches"
      description="Découvre l’HoloGraph, la généalogie interactive de Mythoskolis : un graphe dynamique pour explorer dieux, titans et héros."
      canonical="/"
      type="website"
    />
  </head>

  <body class="min-h-screen flex flex-col bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <Header />

    <main class="flex-1 max-w-5xl mx-auto px-4 py-12 space-y-12">
      <section class="home-hero rounded-3xl bg-white border border-gray-200 shadow-sm p-8 flex flex-col gap-4">
        <div class="relative isolate overflow-hidden -mx-8 -mt-8 rounded-2xl">
          <div
            aria-hidden="true"
            class="absolute inset-0 -z-20 bg-[url('/medias/mythoskolis_front.webp')] bg-cover bg-top opacity-80"
          />
          <div aria-hidden="true" class="absolute inset-0 -z-10 bg-white/10" />
          <h1 class="relative z-10 px-8 py-6 text-center font-extrabold leading-tight text-white">
            <span class="block text-4xl md:text-5xl">Mythoskolis</span>
            <span class="block text-2xl md:text-4xl">Rendre la mythologie grecque facile à comprendre</span>
          </h1>
        </div>
        <p class="mt-2 text-lg text-gray-700 max-w-3xl">
          Parcourez les fiches d'entités mythologiques, les récits fondateurs, et comprenez intuitivement les liens de filiation entre les personnages via l'HoloGraph, un arbre généalogique interactif original et inédit.
        </p>
        <div class="flex flex-wrap gap-3">
          <a
            class="inline-flex items-center gap-2 rounded-full bg-indigo-600 text-white px-4 py-2 font-semibold shadow hover:bg-indigo-700 transition"
            href="/entites/"
          >
            Explorer les entités
          </a>
          <a
            class="inline-flex items-center gap-2 rounded-full border border-indigo-200 text-indigo-700 px-4 py-2 font-semibold bg-indigo-50 hover:border-indigo-300 transition"
            href="/genealogie/grecque-zeus/"
          >
            Ouvrir l’HoloGraph
          </a>
        </div>
      </section>


      <section class="mk-card space-y-4 p-8">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold">HoloGraph - généalogie interactive</h2>
          <a
            href="/genealogie/grecque-zeus/"
            class="inline-flex items-center rounded-full border border-slate-200 px-3 py-1.5 text-sm font-semibold text-slate-700 hover:border-indigo-300 hover:bg-indigo-50 transition dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:hover:border-indigo-300/60"
          >
            Ouvrir l’HoloGraph
          </a>
        </div>
        <p class="text-gray-700">
          Naviguez intuitivement dans les complexes relations généalogiques de la mythologie grecque.
        </p>
        <div class="flex justify-center">
          <video
            class="w-full sm:w-4/5 lg:w-1/2 rounded-2xl border border-slate-200 shadow-md dark:border-slate-700"
            autoplay
            muted
            loop
            playsinline
            controlslist="nodownload noplaybackrate"
            disablepictureinpicture
            oncontextmenu="event.preventDefault();"
          >
            <source src="/medias/holograph.mp4" type="video/mp4" />
            Votre navigateur ne supporte pas la vidéo HTML5.
          </video>
        </div>
      </section>

      <section class="space-y-4 rounded-3xl bg-white border border-gray-200 shadow-sm p-8">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-semibold">Quelques entités à découvrir</h2>
        </div>
        <div data-home-random-entities class="grid gap-4 sm:grid-cols-2 md:grid-cols-3">
          <p class="text-gray-500">Chargement des entités...</p>
        </div>
      </section>

      <section class="space-y-4 rounded-3xl bg-white border border-gray-200 shadow-sm p-8">
        <div class="flex items-center gap-3">
          <h2 class="text-2xl font-semibold">Ressources</h2>
          <a
            href="/ressources/"
            class="ml-auto inline-flex items-center justify-center whitespace-nowrap rounded-full border border-gray-200 px-3 py-1.5 text-sm font-semibold text-gray-700 hover:border-indigo-300 hover:bg-indigo-50 transition text-center"
          >
            Voir toutes les ressources
          </a>
        </div>
      </section>

      <section class="space-y-3 rounded-3xl bg-white border border-gray-200 shadow-sm p-8">
        <h2 class="text-2xl font-semibold">À propos</h2>
        <p class="text-gray-700">
          Mythoskolis est un projet personnel conçu avec Astro et Tailwind.
          Il sert de vitrine culturelle et surtout de démonstration technique : modélisation de données complexes, structuration YAML, et visualisation dynamique via l’HoloGraph.
          Toutes les fiches et relations sont versionnées, sourcées, et générées à partir de données organisées.
        </p>
        <div class="flex flex-wrap gap-3 text-sm">
          <a href="/a-propos/" class="inline-flex items-center rounded-full border border-gray-200 px-3 py-1.5 hover:border-gray-300">
            En savoir plus
          </a>
      </a>
    </div>
  </section>
</main>

<Footer />

<script type="application/json" id="home-random-entities-data" set:html={serializedEntites}></script>

<script>
  (() => {
    const renderRandomEntities = () => {
      const container = document.querySelector('[data-home-random-entities]');
      const dataEl = document.getElementById('home-random-entities-data');
      if (!container || !dataEl) return;

      try {
        const parsed = JSON.parse(dataEl.textContent || '[]');
        console.debug('[home-entities] parsed length', Array.isArray(parsed) ? parsed.length : 'non-array');
        if (!Array.isArray(parsed) || parsed.length === 0) {
          container.innerHTML = '<p class="text-gray-500">Aucune entité illustrée pour le moment.</p>';
          return;
        }

        const selection = parsed
          .map((value) => ({ value, sort: Math.random() }))
          .sort((a, b) => a.sort - b.sort)
          .slice(0, 3)
          .map(({ value }) => value);

        const fragment = document.createDocumentFragment();

        selection.forEach((ent) => {
          const card = document.createElement('a');
          card.href = `/entites/${ent.id}/`;
          card.className =
            'home-entity-card group relative overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition';

          const img = document.createElement('img');
          img.src = ent.faceSrc;
          img.alt = `Portrait de ${ent.title}`;
          img.className = 'h-40 w-full object-cover bg-gray-100';
          img.loading = 'lazy';
          img.draggable = false;
          card.appendChild(img);

          const info = document.createElement('div');
          info.className = 'p-4 flex items-center justify-between';

          const texts = document.createElement('div');
          const title = document.createElement('p');
          title.className = 'home-entity-title text-lg font-semibold text-gray-900 group-hover:text-indigo-700 transition';
          title.textContent = ent.title;

          const role = document.createElement('p');
          role.className = 'home-entity-sub text-xs text-gray-500';
          role.textContent = ent.role || 'Fiche détaillée';

          texts.appendChild(title);
          texts.appendChild(role);

          const arrow = document.createElement('span');
          arrow.className = 'text-indigo-600 font-semibold group-hover:translate-x-1 transition';
          arrow.textContent = '→';

          info.appendChild(texts);
          info.appendChild(arrow);

          card.appendChild(info);
          fragment.appendChild(card);
        });

        if (fragment.childNodes.length > 0) {
          container.innerHTML = '';
          container.appendChild(fragment);
        }
      } catch (error) {
        console.error('[home-entities] rendu aléatoire impossible', error);
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', renderRandomEntities, { once: true });
    } else {
      renderRandomEntities();
    }
  })();
</script>

<style>
  :global(.theme-dark .home-entity-card) {
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(148, 163, 184, 0.4);
  }
  :global(.theme-dark .home-entity-title) {
    color: #e5e7eb;
  }
  :global(.theme-dark .home-entity-sub) {
    color: #cbd5e1;
  }
  :global(.theme-dark .home-entity-card .text-indigo-600) {
    color: #c4d4ff;
  }
  /* Hero dark mode */
  :global(.theme-dark .home-hero) {
    background: rgba(8, 12, 26, 0.9);
    border-color: rgba(255, 255, 255, 0.14);
    box-shadow: 0 18px 60px rgba(0, 0, 0, 0.38);
  }
  :global(.theme-dark .home-hero h1) {
    color: #ffffff;
  }
  :global(.theme-dark .home-hero p:not(.text-indigo-600)) {
    color: #cbd5e1;
  }
  :global(.theme-dark .home-hero .text-indigo-600) {
    color: #a5b4fc;
  }
  :global(.theme-dark .home-hero a[href="/entites/"]) {
    background: linear-gradient(135deg, #3b57ff, #2d3fc7);
    color: #f9fbff;
    box-shadow: 0 14px 34px rgba(59, 87, 255, 0.35);
  }
  :global(.theme-dark .home-hero a[href="/entites/"]:hover) {
    background: linear-gradient(135deg, #4865ff, #3247d6);
  }
  :global(.theme-dark .home-hero a[href="/genealogie/grecque-zeus/"]) {
    color: #f6f8ff;
    border-color: rgba(255, 255, 255, 0.32);
    background: rgba(255, 255, 255, 0.08);
  }
  :global(.theme-dark .home-hero a[href="/genealogie/grecque-zeus/"]:hover) {
    border-color: rgba(255, 255, 255, 0.5);
    background: rgba(255, 255, 255, 0.12);
  }
</style>
</body>
</html>
