---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import MetaTags from '../../components/MetaTags.astro';
import '../../styles/global.css';
import { getCollection, getEntry } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const recits = await getCollection('recits');
const tagEntry = await getEntry('data', 'tags-recits');
const tagLabelMap = new Map<string, string>();
tagEntry?.data?.categories?.forEach((cat) => {
  cat.tags.forEach((t) => tagLabelMap.set(t.id, t.label));
});

const recitsWithTags = recits.map((r) => {
  const tagIds = r.data.tags || [];
  const tagLabels = tagIds.map((id) => tagLabelMap.get(id) ?? id);
  const imagePath = path.join(process.cwd(), 'public', 'recits_images', `${r.data.id}.webp`);
  const imageUrl = fs.existsSync(imagePath) ? `/recits_images/${r.data.id}.webp` : null;
  return { ...r, tagIds, tagLabels, imageUrl };
});

const sorted = recitsWithTags
  .slice()
  .sort((a, b) => a.data.title.localeCompare(b.data.title, 'fr', { sensitivity: 'base' }));
const pageTitle = "Récits mythologiques | Mythoskolis";
const pageDescription =
  "Parcours les récits et épisodes mythologiques : résumés sourcés, personnages impliqués et contexte.";
---

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <MetaTags
    title={pageTitle}
    description={pageDescription}
    canonical="/recits/"
    type="website"
  />
</head>

  <body class="min-h-screen flex flex-col bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <Header />

    <main class="flex-1 max-w-5xl mx-auto px-4 py-12 space-y-8">
      <div class="space-y-3">
        <p class="mk-kicker">Corpus</p>
        <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-50">Récits mythologiques</h1>
        <p class="mk-lead max-w-3xl  text-slate-500 dark:text-slate-300">
          Episodes, enlèvements, naissances ou rivalités : explore les récits structurants des mythes, avec leurs sources et les personnages impliqués.
        </p>
        <div class="space-y-2 max-w-xl">
          <label for="tag-filter" class="text-sm text-slate-600 dark:text-slate-300">Filtrer par thématiques</label>
          <div class="relative flex items-center">
            <input id="tag-filter" type="text" placeholder="ex : jalousie, descente aux enfers…" class="mk-input pr-10" />
            <button
              id="tag-filter-clear"
              type="button"
              aria-label="Effacer le filtre"
              class="absolute right-3 text-lg text-slate-400 transition hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-100"
            >
              ×
            </button>
          </div>
        </div>
        <div class="mt-1">
          <a href="/recits/tags/" class="mk-pill text-sm p-3 bg-blue-50 dark:bg-blue-950">Voir les thématiques</a>
        </div>
      </div>

      {sorted.length === 0 ? (
        <p class="text-slate-600 dark:text-slate-300">Aucun récit n'est encore disponible.</p>
      ) : (
        <div id="recits-grid" class="grid gap-4 sm:grid-cols-2">
          {sorted.map((recit) => {
            const tagString = (recit.tagLabels || []).join(' ');
            return (
              <a
                href={`/recits/${recit.slug}/`}
                class="recit-card mk-card group relative block overflow-hidden transition hover:shadow-md dark:hover:shadow-lg"
                data-tags={tagString}
                data-search={`${recit.data.title} ${tagString}`}
              >
                {recit.imageUrl ? (
                  <>
                    <div
                      class="absolute inset-0 bg-cover bg-center transition-transform duration-200 group-hover:scale-[1.02]"
                      style={`background-image: url(${recit.imageUrl});`}
                    />
                    <div class="absolute inset-0 bg-slate-900/50 transition duration-200 group-hover:bg-slate-900/40" />
                  </>
                ) : null}

                <div class={`mk-card-body relative flex h-full flex-col ${recit.imageUrl ? 'text-white' : ''}`}>
                  <h2 class={`mk-card-title ${recit.imageUrl ? 'text-white' : ''}`}>{recit.data.title}</h2>
                  {recit.data.era && (
                    <p class={`text-xs mt-1 ${recit.imageUrl ? 'text-slate-100/90' : 'text-slate-500 dark:text-slate-300'}`}>
                      {recit.data.era}
                    </p>
                  )}
                  {recit.data.summary && (
                    <p class={`text-sm mt-3 line-clamp-3 ${recit.imageUrl ? 'text-white/95' : 'text-slate-600 dark:text-slate-300'}`}>
                      {recit.data.summary}
                    </p>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      )}
    </main>

    <Footer />

    <script>
      const input = document.getElementById('tag-filter');
      const clearBtn = document.getElementById('tag-filter-clear');
      const cards = Array.from(document.querySelectorAll('.recit-card'));

      const normalize = (str) =>
        str
          .normalize('NFD')
          .replace(/\p{Diacritic}/gu, '')
          .toLowerCase();

      const applyFilter = () => {
        const q = normalize(input?.value || '');
        cards.forEach((card) => {
          const haystack = normalize(card.dataset.search || card.dataset.tags || '');
          if (!q || haystack.includes(q)) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
      };

      const params = new URLSearchParams(window.location.search);
      const initial = params.get('tag') || '';
      if (input) input.value = initial;

      input?.addEventListener('input', applyFilter);
      clearBtn?.addEventListener('click', () => {
        if (!input) return;
        input.value = '';
        applyFilter();
        input.focus();
      });
      applyFilter();
    </script>
  </body>
</html>
