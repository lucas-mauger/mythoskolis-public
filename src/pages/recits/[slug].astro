---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import MetaTags from '../../components/MetaTags.astro';
import '../../styles/global.css';
import { getCollection, getEntry } from 'astro:content';
import { getGlossaryEntries } from '../../lib/glossaire';
import ContextualLayerScript from '../../components/ContextualLayerScript.astro';
import fs from 'node:fs';
import path from 'node:path';
import { isPublishedEntry } from '../../utils/content-filters';

export async function getStaticPaths() {
  const recits = await getCollection('recits', isPublishedEntry);
  const entites = await getCollection('entites', isPublishedEntry);
  const entiteById = new Map(entites.map((e) => [e.data.id, e]));

  return recits.map((recit) => ({
    params: { slug: recit.slug },
    props: { recit, entiteById },
  }));
}

const { recit, entiteById } = Astro.props;
const { Content, headings } = await recit.render();
const pageTitle = `${recit.data.title} | Mythoskolis`;
const pageDescription = recit.data.summary ?? recit.data.title;
const recitImagePath = path.join(process.cwd(), 'public', 'recits_images', `${recit.data.id}.webp`);
const recitImageUrl = fs.existsSync(recitImagePath) ? `/recits_images/${recit.data.id}.webp` : null;

const tagsEntry = await getEntry('data', 'tags-recits');
const tagLabelMap = new Map<string, string>();
tagsEntry?.data?.categories?.forEach((cat) => {
  cat.tags.forEach((t) => tagLabelMap.set(t.id, t.label));
});
const tagList = (recit.data.tags || [])
  .map((id) => ({ id, label: tagLabelMap.get(id) ?? id }))
  .filter((t, idx, arr) => arr.findIndex((x) => x.id === t.id) === idx);

function getFaceForEntity(entity) {
  const gender = entity?.data?.gender?.toLowerCase?.() ?? 'x';
  const id = entity?.data?.id;
  if (!id) return null;
  const abs = path.join(process.cwd(), 'public', 'faces', 'grecque', `${id}.webp`);
  if (fs.existsSync(abs)) return `/faces/grecque/${id}.webp`;
  // Pas de portrait disponible : pas d'image de fallback
  return null;
}

const mainEntities = (recit.data.main_entities || [])
  .map((id) => entiteById.get(id))
  .filter(Boolean)
  .map((ent) => ({
    id: ent.data.id,
    title: ent.data.title,
    img: getFaceForEntity(ent),
  }));

const glossaryEntries = getGlossaryEntries();
const entityLayerEntries = Array.from(entiteById.values())
  .map((ent) => {
    const id = ent?.data?.id;
    const title = ent?.data?.title?.toString().trim();
    if (!title) return null;
    return {
      type: 'entity',
      name: title,
      title,
      role: ent?.data?.role?.toString() ?? '',
      image: getFaceForEntity(ent),
    };
  })
  .filter(Boolean);
const layerEntries = [
  ...glossaryEntries.map((g) => ({ type: 'glossary', name: g.name, definition: g.definition })),
  ...entityLayerEntries,
];

const opponentEntities = (recit.data.opponents || [])
  .map((id) => entiteById.get(id))
  .filter(Boolean)
  .map((ent) => ({
    id: ent.data.id,
    title: ent.data.title,
    img: getFaceForEntity(ent),
  }));
---

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <MetaTags
    title={pageTitle}
    description={pageDescription}
    canonical={`/recits/${recit.slug}/`}
    type="article"
  />
</head>

  <body class="min-h-screen flex flex-col bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <Header />

    <main class="flex-1 max-w-4xl mx-auto px-4 py-12 space-y-8">
      <div class="flex flex-wrap gap-3 text-sm">
        <a href="/recits/" class="badge-link badge-link--neutral badge-link--back">Tous les récits</a>
      </div>

      <header class="space-y-2">
        <p class="mk-kicker">Récit</p>
        <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-50">{recit.data.title}</h1>
        {recit.data.summary && <p class="mk-lead  text-slate-500 dark:text-slate-300">{recit.data.summary}</p>}

        {(recit.data.era || recit.data.importance) && (
          <div class="chip-row flex flex-wrap gap-2 sm:gap-2.5 py-1 w-full max-w-full box-border text-xs text-slate-600 dark:text-slate-200 mt-2">
            {recit.data.era && <span class="px-2 py-1 rounded-full border border-slate-300 bg-slate-100 dark:border-slate-600 dark:bg-slate-800/80">{recit.data.era}</span>}
            {recit.data.importance && (
              <span class="px-2 py-1 rounded-full border border-indigo-200 bg-indigo-50 uppercase tracking-wide text-indigo-700 dark:border-indigo-300/60 dark:bg-indigo-900/40 dark:text-indigo-100">
                {recit.data.importance}
              </span>
            )}
          </div>
        )}
      </header>

      {(recit.data.main_entities?.length || recit.data.opponents?.length) && (
        <section class="space-y-4">
          {mainEntities.length > 0 && (
            <div class="entity-strip mk-card w-full max-w-full box-border rounded-2xl p-4 space-y-3">
              <div class="strip-header">
                <h2 class="text-[1.05rem] font-bold text-slate-900 dark:text-slate-50">Protagonistes</h2>
              </div>
              <div class="chip-row flex flex-wrap gap-3 sm:gap-3.5 py-2 w-full max-w-full box-border">
                {mainEntities.map((ent) => (
                  <a
                    href={`/entites/${ent.id}/`}
                    class={`chip mk-chip inline-flex items-center gap-2 rounded-full px-3 py-2 text-[0.95rem] font-semibold transition hover:-translate-y-[1px] ${
                      ent.img ? '' : ''
                    }`}
                  >
                    {ent.img && (
                      <img
                        src={ent.img}
                        alt={`Portrait de ${ent.title}`}
                        loading="lazy"
                        class="w-12 h-12 rounded-full object-cover border border-black/5 flex-shrink-0 dark:border-slate-600"
                      />
                    )}
                    <span class="whitespace-nowrap">{ent.title}</span>
                  </a>
                ))}
              </div>
            </div>
          )}
          {opponentEntities.length > 0 && (
            <div class="entity-strip mk-card w-full max-w-full box-border rounded-2xl p-4 space-y-3">
              <div class="strip-header">
                <h2 class="text-[1.05rem] font-bold text-slate-900 dark:text-slate-50">Antagonistes</h2>
              </div>
              <div class="chip-row flex flex-wrap gap-3 sm:gap-3.5 py-2 w-full max-w-full box-border">
                {opponentEntities.map((ent) => (
                  <a
                    href={`/entites/${ent.id}/`}
                    class={`chip mk-chip inline-flex items-center gap-2 rounded-full px-3 py-2 text-[0.95rem] font-semibold transition hover:-translate-y-[1px] ${
                      ent.img ? '' : ''
                    }`}
                  >
                    {ent.img && (
                      <img
                        src={ent.img}
                        alt={`Portrait de ${ent.title}`}
                        loading="lazy"
                        class="w-12 h-12 rounded-full object-cover border border-black/5 flex-shrink-0 dark:border-slate-600"
                      />
                    )}
                    <span class="whitespace-nowrap">{ent.title}</span>
                  </a>
                ))}
              </div>
            </div>
          )}
        </section>
      )}

      {recitImageUrl && (
        <div class="recit-hero my-4">
          <img
            src={recitImageUrl}
            alt={`Illustration du récit ${recit.data.title}`}
            loading="lazy"
            class="w-full rounded-xl object-cover shadow-lg border border-slate-200 dark:border-slate-700"
          />
        </div>
      )}

      <article class="mk-prose-card max-w-none p-2" data-contextual-scope="recit">
        <div class="sticky top-4 z-40 w-full relative" data-contextual-floater>
          <div class="flex items-center justify-end gap-2" data-context-controls>
            <button
              type="button"
              aria-label="Réglages lecture contextuelle"
              data-contextual-settings
              class="inline-flex h-12 w-12 items-center justify-center rounded-full border border-slate-200 bg-white/80 text-slate-900 backdrop-blur transition hover:-translate-y-px hover:shadow-sm dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100"
            >
              <span class="sr-only">Réglages lecture contextuelle</span>
              <svg
                aria-hidden="true"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.6"
                class="h-5 w-5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 9.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5Zm8.5 2.5a8.48 8.48 0 0 0-.12-1.4l1.93-1.51a.5.5 0 0 0 .11-.65l-1.83-3.17a.5.5 0 0 0-.62-.2l-2.27.92a8.54 8.54 0 0 0-2.44-1.4l-.34-2.43A.5.5 0 0 0 13.5 2h-3a.5.5 0 0 0-.5.42l-.34 2.43a8.54 8.54 0 0 0-2.44 1.4l-2.27-.92a.5.5 0 0 0-.62.2L2.5 8.5a.5.5 0 0 0 .11.65l1.93 1.51a8.48 8.48 0 0 0 0 2.8l-1.93 1.51a.5.5 0 0 0-.11.65l1.83 3.17a.5.5 0 0 0 .62.2l2.27-.92a8.54 8.54 0 0 0 2.44 1.4l.34 2.43a.5.5 0 0 0 .5.42h3a.5.5 0 0 0 .5-.42l.34-2.43a8.54 8.54 0 0 0 2.44-1.4l2.27.92a.5.5 0 0 0 .62-.2l1.83-3.17a.5.5 0 0 0-.11-.65l-1.93-1.51c.08-.46.12-.93.12-1.4Z"
                />
              </svg>
            </button>
            <div
              data-contextual-settings-panel
              class="absolute right-0 top-full mt-2 min-w-[15rem] w-max rounded-xl border border-slate-200 bg-white/90 p-3 text-sm shadow-lg backdrop-blur transition dark:border-slate-700 dark:bg-slate-900/90 hidden"
            >
              <div class="mb-3 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
                Options
              </div>
              <div class="space-y-3">
                <div class="space-y-2">
                  <p class="text-xs font-semibold text-slate-600 dark:text-slate-200">Répétitions</p>
                  <div class="flex gap-2">
                    <button
                      type="button"
                      data-context-density="all"
                      class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                    >
                      Tout
                    </button>
                    <button
                      type="button"
                      data-context-density="first"
                      class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                    >
                      1ère fois
                    </button>
                  </div>
                </div>
              <div class="space-y-2 border-t border-slate-200 pt-3 mt-3 dark:border-slate-700">
                <p class="text-xs font-semibold text-slate-600 dark:text-slate-200">Surligner</p>
                <div class="flex flex-col gap-2 text-sm text-slate-800 dark:text-slate-100">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" data-context-entities checked class="h-4 w-4 rounded border-slate-300 text-amber-500 focus:ring-amber-300 dark:border-slate-600 dark:bg-slate-900" />
                    <span>Entités</span>
                  </label>
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" data-context-glossary checked class="h-4 w-4 rounded border-slate-300 text-amber-500 focus:ring-amber-300 dark:border-slate-600 dark:bg-slate-900" />
                    <span>Mots-clés</span>
                  </label>
                </div>
              </div>
              <div class="space-y-2 border-t border-slate-200 pt-3 mt-3 dark:border-slate-700">
                <p class="text-xs font-semibold text-slate-600 dark:text-slate-200">Flottant</p>
                <button
                  type="button"
                  data-context-float
                  class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                >
                  Activer
                </button>
              </div>
              <div class="space-y-2 border-t border-slate-200 pt-3 mt-3 sm:hidden dark:border-slate-700">
                <p class="text-xs font-semibold text-slate-600 dark:text-slate-200">Position</p>
                <div class="grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    data-context-position="hg"
                    class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                  >
                    ↖️
                  </button>
                  <button
                    type="button"
                    data-context-position="hd"
                    class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                  >
                    ↗️
                  </button>
                  <button
                    type="button"
                    data-context-position="bg"
                    class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                  >
                    ↙️
                  </button>
                  <button
                    type="button"
                    data-context-position="bd"
                    class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-800 transition hover:-translate-y-[1px] hover:shadow-sm dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
                  >
                    ↘️
                  </button>
                </div>
              </div>
            </div>
          </div>
        <button
          type="button"
            data-contextual-toggle
            aria-pressed="false"
            class="inline-flex h-12 items-center gap-2 whitespace-nowrap rounded-full border px-3 text-sm font-semibold leading-none transition hover:-translate-y-px hover:shadow-sm border-slate-200 bg-white/80 text-slate-900 backdrop-blur dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100"
          >
            <span
              aria-hidden="true"
              data-contextual-indicator
              class="inline-block h-3 w-3 rounded-full border border-slate-400 bg-transparent transition"
            ></span>
            <span data-contextual-label>Lecture contextualisée</span>
            <img
              src="/icons/contextual_clear.webp"
              alt=""
              aria-hidden="true"
              class="block h-5 w-5 shrink-0 object-contain dark:hidden"
              loading="lazy"
            />
            <img
              src="/icons/contextual_dark.webp"
              alt=""
              aria-hidden="true"
              class="hidden block h-5 w-5 shrink-0 object-contain dark:block"
              loading="lazy"
            />
          </button>
          </div>
        </div>
        <div data-contextual-body>
          <Content />
        </div>
      </article>

      {tagList.length > 0 && (
      <section class="entity-strip mk-card w-full max-w-full box-border rounded-2xl p-4 space-y-3 shadow-sm">
        <h2 class="text-[1.05rem] font-bold text-slate-900 dark:text-slate-50">Thèmes abordés</h2>
        <div class="flex flex-wrap gap-2">
          {tagList.map((tag) => (
            <a
                href={`/recits/?tag=${encodeURIComponent(tag.label)}`}
                class="chip mk-chip inline-flex items-center gap-2 rounded-full bg-slate-50 px-3 py-1.5 text-sm font-semibold text-slate-900 transition hover:-translate-y-[1px]"
              >
                {tag.label}
              </a>
            ))}
          </div>
        </section>
      )}

      <ContextualLayerScript entries={layerEntries} scopeSelector="[data-contextual-scope='recit']" />
    </main>

    <Footer />
  </body>
</html>
